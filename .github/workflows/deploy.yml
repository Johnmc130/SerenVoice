# ============================================
# SerenVoice - Pipeline CI/CD
# Despliegue automÃ¡tico a Google Cloud
# ============================================

name: Deploy SerenVoice

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  BACKEND_SERVICE: serenvoice-backend
  FRONTEND_BUCKET: serenvoice-frontend

jobs:
  # ============================================
  # Job 1: Testing
  # ============================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: ğŸ“¦ Instalar dependencias backend
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: ğŸ§ª Ejecutar tests backend
        run: |
          cd backend
          pytest tests/ -v --cov=. --cov-report=xml || true

      - name: ğŸ“Š Subir cobertura
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          fail_ci_if_error: false

  # ============================================
  # Job 2: Build con Go
  # ============================================
  build-go:
    name: ğŸ”¨ Build Go Scripts
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: 'deploy/go.sum'

      - name: ğŸ“¦ Descargar dependencias Go
        run: |
          cd deploy
          go mod download
          go mod tidy

      - name: ğŸ”¨ Compilar script de despliegue
        run: |
          cd deploy
          go build -o deploy-serenvoice deploy.go

      - name: ğŸ“¤ Guardar artefacto
        uses: actions/upload-artifact@v4
        with:
          name: deploy-binary
          path: deploy/deploy-serenvoice

  # ============================================
  # Job 3: Deploy Backend a Cloud Run
  # ============================================
  deploy-backend:
    name: ğŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: [test, build-go]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ğŸ” Autenticar con Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: ğŸ³ Configurar Docker para GCR
        run: gcloud auth configure-docker

      - name: ğŸ—ï¸ Build imagen Docker
        run: |
          cd backend
          docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} .
          docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:latest

      - name: ğŸ“¤ Push imagen a GCR
        run: |
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:latest

      - name: ğŸš€ Deploy a Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --set-env-vars "FLASK_ENV=production" \
            --set-env-vars "DB_HOST=${{ secrets.DB_HOST }}" \
            --set-env-vars "DB_PORT=${{ secrets.DB_PORT }}" \
            --set-env-vars "DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars "DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" \
            --quiet

      - name: ğŸ“‹ Obtener URL del servicio
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region ${{ env.REGION }} --format='value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Backend URL: $URL"

      - name: âœ… Health Check
        run: |
          sleep 10
          curl -f ${{ steps.get-url.outputs.service_url }}/api/health || echo "Health check pendiente"

      - name: âš ï¸ Deployment skipped
        run: |
          echo "âš ï¸ Deployment omitido - secretos de GCP no configurados"
          echo "Configure GCP_SA_KEY, GCP_PROJECT_ID y otros secretos en GitHub Settings > Secrets"

    outputs:
      backend_url: ${{ steps.get-url.outputs.service_url }}

  # ============================================
  # Job 4: Deploy Cloud Function (Go)
  # ============================================
  deploy-function:
    name: âš¡ Deploy Cloud Function
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ğŸ” Autenticar con Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: âš¡ Deploy Health Check Function
        run: |
          gcloud functions deploy serenvoice-health \
            --gen2 \
            --runtime go121 \
            --trigger-http \
            --allow-unauthenticated \
            --region ${{ env.REGION }} \
            --source functions/health \
            --entry-point HealthCheck \
            --memory 256MB \
            --set-env-vars "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --quiet || echo "Cloud Functions deployment skipped"

  # ============================================
  # Job 5: Deploy Frontend
  # ============================================
  deploy-frontend:
    name: ğŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: proyectofinal-frontend/package-lock.json

      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd proyectofinal-frontend
          npm ci

      - name: ğŸ—ï¸ Build frontend
        env:
          VITE_API_URL: ${{ needs.deploy-backend.outputs.backend_url }}
        run: |
          cd proyectofinal-frontend
          npm run build

      - name: ğŸ” Autenticar con Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸš€ Deploy a Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.GCP_SA_KEY }}
          projectId: ${{ secrets.GCP_PROJECT_ID }}
          channelId: live
          entryPoint: ./proyectofinal-frontend

  # ============================================
  # Job 6: NotificaciÃ³n
  # ============================================
  notify:
    name: ğŸ“¢ Notificar
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: ğŸ“¢ Resumen del despliegue
        run: |
          echo "============================================"
          echo "ğŸš€ DESPLIEGUE COMPLETADO - SerenVoice"
          echo "============================================"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸŒ Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "============================================"





