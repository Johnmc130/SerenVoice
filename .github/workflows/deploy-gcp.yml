name: Deploy to GCP VM

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: boreal-dock-481001-k0
  GCP_ZONE: us-central1-a
  VM_NAME: serenvoice-server
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check if VM exists
        id: check_vm
        run: |
          if gcloud compute instances describe ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create VM if not exists
        if: steps.check_vm.outputs.exists == 'false'
        run: |
          gcloud compute instances create ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --machine-type=e2-medium \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size=30GB \
            --tags=http-server,https-server,serenvoice \
            --scopes=cloud-platform,logging-write,monitoring-write \
            --metadata=startup-script='#!/bin/bash
              apt-get update && apt-get install -y docker.io docker-compose git
              systemctl enable docker && systemctl start docker
              mkdir -p /opt/serenvoice
              cd /opt/serenvoice
              git clone ${{ env.REPO_URL }} . || true
              docker compose up -d --build'

      - name: Create firewall rule if not exists
        continue-on-error: true
        run: |
          gcloud compute firewall-rules create serenvoice-allow-web \
            --allow=tcp:80,tcp:443,tcp:5000,tcp:5173,tcp:8080 \
            --target-tags=serenvoice \
            --description="Allow SerenVoice ports" || true

      - name: Deploy to VM
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }} --command="
            cd /opt/serenvoice
            
            # Pull latest changes
            sudo git fetch origin
            sudo git reset --hard origin/main || sudo git reset --hard origin/master
            
            # Create .env from secrets if provided
            if [ -n '${{ secrets.ENV_FILE }}' ]; then
              echo '${{ secrets.ENV_FILE }}' | sudo tee .env > /dev/null
            fi
            
            # Rebuild and restart containers
            sudo docker compose pull 2>/dev/null || true
            sudo docker compose build --no-cache
            sudo docker compose down
            sudo docker compose up -d
            
            # Show status
            sudo docker compose ps
            
            # Clean up old images
            sudo docker image prune -f
          "

      - name: Get VM IP and show URLs
        run: |
          IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Despliegue completado!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Frontend: http://$IP:5173"
          echo "ğŸ”§ Backend:  http://$IP:5000"
          echo "ğŸ“Š phpMyAdmin: http://$IP:8080"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Health check
        continue-on-error: true
        run: |
          IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Esperando a que los servicios estÃ©n listos..."
          sleep 30
          
          echo "Verificando backend..."
          curl -sf http://$IP:5000/api/health || echo "Backend aÃºn iniciando..."
          
          echo "Verificando frontend..."
          curl -sf http://$IP:5173 || echo "Frontend aÃºn iniciando..."
