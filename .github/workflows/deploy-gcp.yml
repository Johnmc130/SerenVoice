name: Deploy to GCP VM

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: boreal-dock-481001-k0
  GCP_ZONE: us-central1-a
  VM_NAME: serenvoice-server
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check if VM exists
        id: check_vm
        run: |
          if gcloud compute instances describe ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create VM if not exists
        if: steps.check_vm.outputs.exists == 'false'
        run: |
          gcloud compute instances create ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --machine-type=e2-medium \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size=30GB \
            --tags=http-server,https-server,serenvoice \
            --scopes=cloud-platform,logging-write,monitoring-write
          
          echo "Esperando a que la VM est√© lista..."
          sleep 60

      - name: Create firewall rule if not exists
        continue-on-error: true
        run: |
          gcloud compute firewall-rules create serenvoice-allow-web \
            --allow=tcp:80,tcp:443,tcp:5000,tcp:5173,tcp:8080,tcp:3306 \
            --target-tags=serenvoice \
            --description="Allow SerenVoice ports" || true

      - name: Setup VM environment
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }} --command="
            # Verificar si Docker est√° instalado
            if ! command -v docker &> /dev/null; then
              echo 'Instalando Docker...'
              sudo apt-get update
              sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release git
              
              # Instalar Docker
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
              echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu jammy stable' | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              sudo systemctl enable docker
              sudo systemctl start docker
              sudo usermod -aG docker \$USER
            fi
            
            # Crear directorio
            sudo mkdir -p /opt/serenvoice
            sudo chown -R \$USER:\$USER /opt/serenvoice
          "

      - name: Deploy application
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }} --command="
            cd /opt/serenvoice
            
            # Clonar o actualizar repositorio
            if [ ! -d '.git' ]; then
              git clone ${{ env.REPO_URL }} .
            else
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi
            
            # Crear .env si no existe
            if [ ! -f '.env' ]; then
              cp .env.example .env 2>/dev/null || echo '# SerenVoice Environment' > .env
            fi
            
            # Construir y levantar contenedores
            sudo docker compose down 2>/dev/null || true
            sudo docker compose build
            sudo docker compose up -d
            
            # Mostrar estado
            sleep 10
            sudo docker compose ps
            
            # Limpiar im√°genes antiguas
            sudo docker image prune -f
          "

      - name: Get VM IP and show URLs
        run: |
          IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo ""
          echo "========================================="
          echo "‚úÖ Despliegue completado!"
          echo "========================================="
          echo "üåê Frontend: http://$IP:5173"
          echo "üîß Backend:  http://$IP:5000"
          echo "üìä phpMyAdmin: http://$IP:8080"
          echo "========================================="
          echo ""
          echo "Para conectar por SSH:"
          echo "gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }}"

      - name: Health check
        continue-on-error: true
        run: |
          IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Esperando a que los servicios est√©n listos..."
          sleep 30
          
          echo "Verificando backend..."
          curl -sf --max-time 10 http://$IP:5000/api/health || echo "Backend a√∫n iniciando..."
          
          echo "Verificando frontend..."
          curl -sf --max-time 10 http://$IP:5173 || echo "Frontend a√∫n iniciando..."
